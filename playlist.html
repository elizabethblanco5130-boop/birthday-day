<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Anti-Vecna Mixtape</title>

  <link href="https://fonts.cdnfonts.com/css/benguiat" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  <style>
    :root{
      --red: rgba(255,0,0,.75);
      --glass: rgba(0,0,0,.45);
      --txt: rgba(255,255,255,.92);
      --cyan: rgba(0,255,255,.72);
      --cyanSoft: rgba(0,255,255,.22);
    }

    *{ box-sizing:border-box; }
    html, body { height:100%; }

    body{
      margin:0;
      background:#000;
      color:#fff;
      font-family: system-ui, -apple-system, Arial;
      overflow:hidden; /* el scroll lo hace el panel internamente */
    }

    /* ===== BACKGROUND IMAGE ===== */
    .bg{ position:fixed; inset:0; background:#000; z-index:0; }
    .bg img{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      filter: saturate(0.95) contrast(1.06);
      transform: scale(1.01);
      user-select:none;
      -webkit-user-drag:none;
      object-position: center top;
    }

    .vignette{
      position:fixed; inset:0;
      background:
        radial-gradient(ellipse at 40% 35%, rgba(0,0,0,.02), rgba(0,0,0,.70)),
        radial-gradient(ellipse at 70% 30%, rgba(0,0,0,.10), rgba(0,0,0,.85));
      pointer-events:none;
      z-index:2;
    }

    .shieldTint{
      position:fixed; inset:0;
      background: radial-gradient(circle at 22% 72%, rgba(255,0,0,.10), rgba(0,0,0,0));
      opacity:.15;
      pointer-events:none;
      z-index:3;
      transition: opacity .6s ease, filter .6s ease;
    }

    /* ===== IDLE VISUALS ===== */
    .idleDark{
      position:fixed; inset:0;
      opacity:0;
      pointer-events:none;
      z-index:20;
      transition: opacity .8s ease;
      background: rgba(0,0,0,.0);
    }
    body.idle .idleDark{ opacity:.45; }

    .idleRed{
      position:fixed; inset:0;
      opacity:0;
      pointer-events:none;
      z-index:21;
      transition: opacity .6s ease;
      background:
        radial-gradient(circle at 50% 45%, rgba(255,0,0,.32), rgba(0,0,0,0) 55%),
        linear-gradient(180deg, rgba(120,0,0,.25), rgba(0,0,0,.35));
      mix-blend-mode: screen;
    }
    body.idle .idleRed{ opacity:1; }

    .stormLayer{
      position:fixed; inset:0;
      pointer-events:none;
      z-index:22;
      opacity:0;
      transition: opacity .25s ease;
    }
    body.idle .stormLayer{ opacity:1; }

    .stormFlash{
      position:absolute; inset:-20%;
      opacity:0;
      mix-blend-mode: screen;
      filter: blur(1px);
      animation: lightning 4.8s infinite;
      background:
        radial-gradient(circle at 70% 30%, rgba(255,0,0,.18), rgba(0,0,0,0) 42%),
        radial-gradient(circle at 25% 55%, rgba(255,80,80,.12), rgba(0,0,0,0) 45%);
    }
    @keyframes lightning{
      0%, 70%, 100% { opacity:0; transform: translate(0,0); }
      72% { opacity:.14; transform: translate(-8px, 4px); }
      73% { opacity:0; }
      76% { opacity:.22; transform: translate(10px, -6px); }
      77% { opacity:0; }
      79% { opacity:.12; transform: translate(-6px, 2px); }
      80% { opacity:0; }
    }

    body.idle .ui{ animation: shake .22s infinite; }
    @keyframes shake{
      0%{ transform: translate(0,0); }
      25%{ transform: translate(1px,-1px); }
      50%{ transform: translate(-1px,1px); }
      75%{ transform: translate(1px,1px); }
      100%{ transform: translate(0,0); }
    }

    /* ===== PARTICLES CANVAS ===== */
    canvas#fx{
      position:fixed; inset:0;
      z-index:4;
      pointer-events:none;
      opacity:.95;
    }

    /* ===== WHISPER ===== */
    .whisper{
      position:fixed;
      top:14px; left:50%;
      transform: translateX(-50%);
      max-width:min(92vw, 740px);
      padding:10px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      backdrop-filter: blur(8px);
      color: rgba(255,255,255,.85);
      font-family: 'Press Start 2P', monospace;
      font-size: 10px;
      letter-spacing: .06em;
      opacity:0;
      z-index:60;
      transition: opacity .35s ease, transform .35s ease;
      pointer-events:none;
      text-align:center;
    }
    .whisper.show{
      opacity:1;
      transform: translateX(-50%) translateY(0);
    }

    /* ===== UI PANEL ===== */
    .ui{
      position:fixed;
      left:16px;
      bottom:16px;
      width:min(420px, calc(100vw - 32px));
      z-index:50;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .panel{
      border-radius:20px;
      border:1px solid rgba(255,0,0,.55);
      background: rgba(0,0,0,.45);
      box-shadow: 0 0 32px rgba(255,0,0,.12);
      backdrop-filter: blur(10px);
      overflow:hidden;

      max-height: calc(100vh - 32px);
      display:flex;
      flex-direction:column;
    }

    .header{
      padding:14px 14px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      flex:0 0 auto;
    }

    .logo{
      margin:0;
      font-family: 'Benguiat', serif;
      letter-spacing: .08em;
      text-transform: uppercase;
      font-size: 34px;
      line-height: .95;
      color: rgba(255,255,255,.92);
      text-shadow:
        0 0 18px rgba(255,0,0,.25),
        2px 0 rgba(0,255,255,.18),
        -2px 0 rgba(255,0,0,.18);
      user-select:none;
      cursor:pointer;
    }
    .subtitle{
      margin:10px 0 0;
      color: rgba(255,255,255,.82);
      font-size: 14px;
      line-height: 1.35;
    }
    .quote{
      margin:10px 0 0;
      font-family: 'Press Start 2P', monospace;
      font-size: 10px;
      color: rgba(255,255,255,.88);
      letter-spacing: .04em;
      line-height: 1.6;
    }

    .playlist{
      padding:14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      overflow:auto;
      flex:1 1 auto;
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
    }

    .track{
      position:relative;
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(255,0,0,.55);
      background: rgba(0,0,0,.38);
      backdrop-filter: blur(8px);
      cursor:pointer;
      user-select:none;
      overflow:hidden;
      min-height:64px;
      transition: transform .12s ease, border-color .12s ease, box-shadow .12s ease;
    }
    .track:hover{ transform: translateY(-1px); }
    .track:active{ transform: translateY(1px); }

    /* ‚úÖ track activo */
    .track.playing{
      border-color: rgba(0,255,255,.70);
      box-shadow:
        0 0 0 2px rgba(0,255,255,.14),
        0 0 26px rgba(0,255,255,.14),
        0 0 18px rgba(255,0,0,.10);
    }

    .track .tag{
      font-family: 'Press Start 2P', monospace;
      font-size: 9px;
      opacity:.85;
      letter-spacing:.06em;
      color: rgba(255,255,255,.78);
      text-transform: uppercase;
    }
    .track .name{
      margin-top:8px;
      font-family: 'Press Start 2P', monospace;
      font-size: 10px;
      line-height:1.5;
      color: rgba(255,255,255,.92);
      letter-spacing:.04em;
      text-transform: uppercase;
    }

    .controls{
      padding:12px 14px;
      border-top: 1px solid rgba(255,255,255,.08);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      flex:0 0 auto;
    }

    .btn{
      flex:1;
      min-width: 140px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,0,0,.60);
      background: rgba(0,0,0,.45);
      color:#fff;
      font-family:'Press Start 2P', monospace;
      font-size:10px;
      letter-spacing:.06em;
      text-transform: uppercase;
      text-decoration:none;
      text-align:center;
      cursor:pointer;
      backdrop-filter: blur(8px);
      user-select:none;
    }
    .btn.main{
      border:2px solid rgba(255,0,0,.75);
      box-shadow: 0 0 18px rgba(255,0,0,.18);
    }

    /* ‚úÖ transport / progreso */
    .transport{
      width:100%;
      display:flex;
      flex-direction:column;
      gap:10px;
      padding:12px 14px;
      border-top: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.25);
      backdrop-filter: blur(8px);
      flex:0 0 auto;
    }

    .transportRow{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .tbtn{
      flex:1;
      min-width: 90px;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(0,255,255,.30);
      background: rgba(0,0,0,.28);
      color:#fff;
      font-family:'Press Start 2P', monospace;
      font-size:11px;
      letter-spacing:.06em;
      text-transform: uppercase;
      cursor:pointer;
      box-shadow: 0 0 18px rgba(0,255,255,.08);
      user-select:none;
    }
    .tbtn:active{ transform: translateY(1px); }

    .tbtn.auto{
      border-color: rgba(255,0,0,.45);
      box-shadow: 0 0 18px rgba(255,0,0,.10);
      min-width: 150px;
    }
    .tbtn.auto.on{
      border-color: rgba(0,255,255,.55);
      box-shadow: 0 0 20px rgba(0,255,255,.12);
    }

    .seekWrap{
      display:flex;
      gap:10px;
      align-items:center;
      width:100%;
    }
    .time{
      font-family:'Press Start 2P', monospace;
      font-size:9px;
      letter-spacing:.06em;
      opacity:.88;
      white-space:nowrap;
    }
    input[type="range"]{
      -webkit-appearance:none;
      appearance:none;
      width:100%;
      height:12px;
      border-radius:999px;
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.10);
      outline:none;
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none;
      appearance:none;
      width:18px; height:18px;
      border-radius:50%;
      background: rgba(0,255,255,.85);
      border:1px solid rgba(0,255,255,.30);
      box-shadow: 0 0 16px rgba(0,255,255,.18);
    }

    /* ===== OBJECTS ===== */
    .objects{
      position:fixed; inset:0;
      z-index:40;
      pointer-events:none;
    }
    .obj{
      position:absolute;
      width:74px; height:74px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      backdrop-filter: blur(6px);
      box-shadow: inset 0 0 0 1px rgba(255,0,0,.12);
      transform: rotate(-6deg);
      pointer-events:auto;
      cursor:pointer;
      user-select:none;
      display:grid;
      place-items:center;
      overflow:hidden;
      transition: transform .16s ease, opacity .25s ease, filter .25s ease;
    }
    .obj:active{ transform: rotate(-6deg) scale(.98); }
    .obj .icon{
      font-size: 22px;
      filter: drop-shadow(0 0 12px rgba(255,0,0,.20));
      opacity:.95;
    }
    .obj .label{
      position:absolute;
      bottom:8px; left:10px; right:10px;
      font-family:'Press Start 2P', monospace;
      font-size:8px;
      letter-spacing:.06em;
      opacity:.82;
      text-transform: uppercase;
      text-align:center;
      color: rgba(255,255,255,.82);
    }

    .obj.clock{ left:14px; top:110px; }
    .obj.walkie{ left:16px; top:235px; transform: rotate(7deg); }
    .obj.bag{ left:16px; bottom:140px; transform: rotate(10deg); }
    .obj.vecna{ right:16px; top:140px; transform: rotate(10deg); opacity:.45; }
    .obj.vecna:hover{ opacity:.85; }

    /* ===== MODAL ===== */
    .modal{
      position:fixed; inset:0;
      display:none;
      z-index:80;
    }
    .modal.show{ display:block; }
    .modal .backdrop{
      position:absolute; inset:0;
      background: rgba(0,0,0,.65);
      backdrop-filter: blur(4px);
    }
    .modal .box{
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%,-50%);
      width:min(92vw, 520px);
      border-radius:18px;
      border:1px solid rgba(255,0,0,.55);
      background: rgba(0,0,0,.55);
      box-shadow: 0 0 30px rgba(255,0,0,.18);
      padding:16px;
    }
    .modal .box h3{
      margin:0 0 10px;
      font-family:'Press Start 2P', monospace;
      font-size:12px;
      letter-spacing:.06em;
      text-transform: uppercase;
    }
    .modal .box p{
      margin:0;
      line-height:1.6;
      color: rgba(255,255,255,.88);
    }
    .modal .box .close{
      margin-top:12px;
      width:100%;
    }

    /* ===== RESPONSIVE ===== */
    @media (min-width: 900px){
      .ui{
        left:auto;
        right:26px;
        bottom:26px;
        width: 460px;
      }
      .logo{ font-size: 40px; }
      .obj{ width:84px; height:84px; }

      .obj.bag{ left:20px; bottom:160px; }
      .obj.walkie{ left:20px; top:260px; }
    }

    @media (min-width: 720px) and (max-width: 899px){
      .ui{
        left:auto;
        right:16px;
        bottom:16px;
        width: min(420px, calc(100vw - 32px));
      }
    }

    @media (max-width: 520px){
      .ui{ left:12px; right:12px; bottom:12px; width:auto; }
      .panel{ max-height: calc(100vh - 24px); }
      .logo{ font-size: 26px; }
      .subtitle{ font-size: 13px; }
      .playlist{ grid-template-columns: 1fr 1fr; }
      .tbtn{ min-width: 88px; }
      .tbtn.auto{ min-width: 150px; }
    }
  </style>
</head>

<body>
  <div class="bg">
    <img id="maxImg" src="img/max.PNG" alt="Max moment">
  </div>

  <div class="vignette"></div>
  <div class="shieldTint"></div>
  <canvas id="fx"></canvas>

  <div class="idleDark"></div>
  <div class="idleRed"></div>

  <div class="stormLayer" aria-hidden="true">
    <div class="stormFlash"></div>
  </div>

  <div class="whisper" id="whisper">Running won‚Äôt save you‚Ä¶</div>

  <div class="objects" id="objects">
    <div class="obj clock" data-obj="clock" title="Reloj roto">
      <div class="icon">üï∞Ô∏è</div>
      <div class="label">clock</div>
    </div>
    <div class="obj walkie" data-obj="walkie" title="Walkie">
      <div class="icon">üìª</div>
      <div class="label">walkie</div>
    </div>
    <div class="obj bag" data-obj="bag" title="Mochila">
      <div class="icon">üéí</div>
      <div class="label">bag</div>
    </div>
    <div class="obj vecna" data-obj="vecna" title="¬øLo viste?">
      <div class="icon">üï≥Ô∏è</div>
      <div class="label">???</div>
    </div>
  </div>

  <div class="ui">
    <section class="panel">
      <div class="header">
        <h1 class="logo" id="logo">ANTI-VECNA<br> MIXTAPE</h1>
        <div class="subtitle">Estas canciones la mantienen a salvo. No son nostalgia. Son supervivencia.</div>
        <div class="quote">‚ÄúWhen the noise gets too loud, this is what brings her back.‚Äù</div>
      </div>

      <div class="playlist" id="playlist">
        <!-- SOLO cambie Cassette 04 => Dajau‚Äô -->
        <div class="track" data-index="0" data-src="" data-title="Song 01" data-artist="Artist">
          <div class="tag">Cassette 01</div><div class="name">Song 01 ‚Äî Artist</div>
        </div>
        <div class="track" data-index="1" data-src="" data-title="Song 02" data-artist="Artist">
          <div class="tag">Cassette 02</div><div class="name">Song 02 ‚Äî Artist</div>
        </div>
        <div class="track" data-index="2" data-src="" data-title="Song 03" data-artist="Artist">
          <div class="tag">Cassette 03</div><div class="name">Song 03 ‚Äî Artist</div>
        </div>
        <div class="track" data-index="3" data-src="" data-title="Dajau‚Äô" data-artist="Artist">
          <div class="tag">Cassette 04</div><div class="name">Dajau‚Äô ‚Äî Artist</div>
        </div>
        <div class="track" data-index="4" data-src="" data-title="Song 05" data-artist="Artist">
          <div class="tag">Cassette 05</div><div class="name">Song 05 ‚Äî Artist</div>
        </div>
        <div class="track" data-index="5" data-src="" data-title="Song 06" data-artist="Artist">
          <div class="tag">Cassette 06</div><div class="name">Song 06 ‚Äî Artist</div>
        </div>
        <div class="track" data-index="6" data-src="" data-title="Song 07" data-artist="Artist">
          <div class="tag">Cassette 07</div><div class="name">Song 07 ‚Äî Artist</div>
        </div>
        <div class="track" data-index="7" data-src="" data-title="Song 08" data-artist="Artist">
          <div class="tag">Cassette 08</div><div class="name">Song 08 ‚Äî Artist</div>
        </div>
        <div class="track" data-index="8" data-src="" data-title="Song 09" data-artist="Artist">
          <div class="tag">Cassette 09</div><div class="name">Song 09 ‚Äî Artist</div>
        </div>
        <div class="track" data-index="9" data-src="" data-title="Song 10" data-artist="Artist">
          <div class="tag">Cassette 10</div><div class="name">Song 10 ‚Äî Artist</div>
        </div>
      </div>

      <!-- ‚úÖ CONTROLES DE REPRODUCCION + PROGRESO + AUTO NEXT -->
      <div class="transport" id="transport">
        <div class="transportRow">
          <button class="tbtn" id="prevBtn" type="button" title="Anterior">‚èÆÔ∏é</button>
          <button class="tbtn" id="ppBtn" type="button" title="Play/Pause">‚èØÔ∏é</button>
          <button class="tbtn" id="nextBtn" type="button" title="Siguiente">‚è≠Ô∏é</button>
          <button class="tbtn auto" id="autoBtn" type="button" title="Auto Next">AUTO: OFF</button>
        </div>

        <div class="seekWrap">
          <div class="time" id="tCur">0:00</div>
          <input id="seek" type="range" min="0" max="1000" value="0" step="1" />
          <div class="time" id="tDur">0:00</div>
        </div>
      </div>

      <div class="controls">
        <a class="btn" href="index.html?v=1000">‚Üê VOLVER</a>
        <button class="btn main" id="panicBtn" type="button">PRESS PLAY</button>
        <a class="btn" href="hub.html?v=1000">HUB ‚Üí</a>
      </div>
    </section>
  </div>

  <audio id="player" preload="auto"></audio>

  <!-- ‚úÖ IDLE AUDIO -->
  <audio id="underw" preload="auto" loop>
    <source src="underw.mp3" type="audio/mpeg">
  </audio>
  <audio id="vecnaAudio" preload="auto">
    <source src="vecna.wav" type="audio/wav">
  </audio>

  <div class="modal" id="modal">
    <div class="backdrop"></div>
    <div class="box">
      <h3 id="modalTitle">SE√ëAL</h3>
      <p id="modalText">...</p>
      <button class="btn close" id="closeModal" type="button">CERRAR</button>
    </div>
  </div>

  <script>
    // =========================
    // PARTICLES (m√°s + m√°s grandes)
    // =========================
    const canvas = document.getElementById("fx");
    const ctx = canvas.getContext("2d");
    let W=0,H=0, dpr=1;

    function resize(){
      dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      W = Math.floor(window.innerWidth);
      H = Math.floor(window.innerHeight);
      canvas.width = Math.floor(W*dpr);
      canvas.height = Math.floor(H*dpr);
      canvas.style.width = W+"px";
      canvas.style.height = H+"px";
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }
    window.addEventListener("resize", resize);
    resize();

    const particles = [];
    const COUNT = 220;
    const rand = (a,b)=> a + Math.random()*(b-a);

    for(let i=0;i<COUNT;i++){
      particles.push({
        x: rand(0,W), y: rand(0,H),
        r: rand(1.2, 3.6),
        vx: rand(-0.22, 0.26),
        vy: rand(-0.36, 0.18),
        a: rand(0.06, 0.22),
        tw: rand(0, Math.PI*2)
      });
    }

    function tick(){
      ctx.clearRect(0,0,W,H);
      for(const p of particles){
        p.tw += 0.02;
        p.x += p.vx + Math.sin(p.tw)*0.10;
        p.y += p.vy;

        if(p.x < -10) p.x = W+10;
        if(p.x > W+10) p.x = -10;
        if(p.y < -10) p.y = H+10;
        if(p.y > H+10) p.y = -10;

        ctx.beginPath();
        ctx.fillStyle = `rgba(255,255,255,${p.a})`;
        ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
        ctx.fill();

        if(Math.random() < 0.008){
          ctx.beginPath();
          ctx.fillStyle = `rgba(255,0,0,${rand(0.08,0.20)})`;
          ctx.arc(p.x+rand(-4,4), p.y+rand(-4,4), p.r+rand(1.2,2.2), 0, Math.PI*2);
          ctx.fill();
        }
      }
      requestAnimationFrame(tick);
    }
    tick();

    // =========================
    // Whisper helper
    // =========================
    const whisper = document.getElementById("whisper");
    function showWhisper(msg){
      whisper.textContent = msg;
      whisper.classList.add("show");
      setTimeout(()=>whisper.classList.remove("show"), 1800);
    }

    // =========================
    // Modal
    // =========================
    const modal = document.getElementById("modal");
    const modalTitle = document.getElementById("modalTitle");
    const modalText = document.getElementById("modalText");
    const closeModal = document.getElementById("closeModal");

    function openModal(title, text){
      modalTitle.textContent = title;
      modalText.textContent = text;
      modal.classList.add("show");
    }
    function close(){
      modal.classList.remove("show");
    }
    closeModal.addEventListener("click", close);
    modal.querySelector(".backdrop").addEventListener("click", close);

    const objMessages = {
      clock: { title:"RELOJ ROTO", text:"El tiempo aqu√≠ no avanza‚Ä¶ se repite. Si te quedas quieta, √©l te encuentra." },
      walkie:{ title:"WALKIE", text:"üì° ‚ÄòDay‚Ä¶ ¬øme copias? Si escuchas est√°tica, no apagues. RESPONDE con m√∫sica.‚Äô" },
      bag:   { title:"MOCHILA", text:"Dentro hay cosas peque√±as que pesan mucho: recuerdos, rutas, y una canci√≥n que siempre vuelve." }
    };

    let vecnaTaps = 0;

    // =========================
    // AUDIO (iPhone/iPad FIX real)
    // =========================
    const player = document.getElementById("player");
    const aUnderw = document.getElementById("underw");
    const aVecna  = document.getElementById("vecnaAudio");

    let audioUnlocked = false;
    let vecnaHasPlayedThisVisit = false;
    let inIdle = false;
    let idleTimer = null;
    let vecnaDelayTimer = null;

    // ‚úÖ bandera de ‚Äúhay canci√≥n sonando‚Äù
    let isSongPlaying = false;

    function stopIdleAudio(){
      clearTimeout(vecnaDelayTimer);
      vecnaDelayTimer = null;

      if(aUnderw){ try{ aUnderw.pause(); }catch(e){} }
      if(aVecna){ try{ aVecna.pause(); }catch(e){} }
    }

    function startIdleAudioSequence(){
      if(!audioUnlocked) return;
      if(isSongPlaying) return;

      if(aUnderw){
        try{
          aUnderw.loop = true;
          aUnderw.volume = 0.55;
          aUnderw.play().catch(()=>{});
        }catch(e){}
      }

      clearTimeout(vecnaDelayTimer);
      vecnaDelayTimer = setTimeout(()=>{
        if(!inIdle) return;
        if(isSongPlaying) return;
        if(vecnaHasPlayedThisVisit) return;

        if(aVecna){
          try{
            aVecna.loop = false;
            aVecna.volume = 0.75;
            aVecna.currentTime = 0;
            aVecna.play().then(()=>{ vecnaHasPlayedThisVisit = true; }).catch(()=>{});
          }catch(e){}
        } else {
          vecnaHasPlayedThisVisit = true;
        }
      }, 7000);
    }

    // ‚úÖ IDLE visual SOLO si no hay canci√≥n sonando
    function setIdle(on){
      // si hay canci√≥n sonando, jam√°s permitimos idle visuals
      if(isSongPlaying) on = false;

      inIdle = on;
      document.body.classList.toggle("idle", on);

      if(on){
        showWhisper("Running won‚Äôt save you‚Ä¶");
        startIdleAudioSequence();
      }else{
        stopIdleAudio();
      }
    }

    // ‚úÖ 6.5s sin tocar Y sin canci√≥n => idle
    function resetIdle(){
      if(isSongPlaying) return;

      setIdle(false);
      clearTimeout(idleTimer);
      idleTimer = setTimeout(()=> setIdle(true), 6500);
    }

    // ‚úÖ ‚Äúprime‚Äù audio para iOS
    function unlockAudioNow(){
      if(audioUnlocked) return;
      audioUnlocked = true;

      const prime = (a)=>{
        if(!a) return;
        try{
          a.muted = true;
          const p = a.play();
          if(p){
            p.then(()=>{
              a.pause();
              a.currentTime = 0;
              a.muted = false;
            }).catch(()=>{ a.muted = false; });
          }else{
            a.muted = false;
          }
        }catch(e){}
      };

      prime(aUnderw);
      prime(aVecna);
      prime(player);

      // si ya estabas idle al desbloquear, inicia secuencia
      if(inIdle && !isSongPlaying){
        startIdleAudioSequence();
      }else{
        resetIdle();
      }
    }

    window.addEventListener("pointerdown", unlockAudioNow, { once:true });
    window.addEventListener("touchstart", unlockAudioNow, { once:true, passive:true });
    window.addEventListener("click", unlockAudioNow, { once:true });

    ["pointerdown","mousemove","touchstart","keydown","scroll"].forEach(ev=>{
      window.addEventListener(ev, resetIdle, { passive:true });
    });
    resetIdle();

    // =========================
    // OBJECTS click
    // =========================
    document.querySelectorAll(".obj").forEach(o=>{
      o.addEventListener("click", ()=>{
        if(!audioUnlocked) unlockAudioNow();
        resetIdle();

        const k = o.dataset.obj;

        if(k === "vecna"){
          vecnaTaps++;
          if(vecnaTaps >= 3){
            vecnaTaps = 0;
            openModal("¬øLO VISTE?", "No lo mires por mucho tiempo. Presiona PLAY. Mantente aqu√≠.");
            showWhisper("Don‚Äôt stop listening‚Ä¶");
            setIdle(true);
          }else{
            showWhisper("‚Ä¶");
          }
          return;
        }

        const m = objMessages[k];
        if(m) openModal(m.title, m.text);
      });
    });

    // =========================
    // PLAYLIST + CONTROLES
    // =========================
    const tracks = [...document.querySelectorAll(".track")];
    const panicBtn = document.getElementById("panicBtn");

    const prevBtn = document.getElementById("prevBtn");
    const ppBtn   = document.getElementById("ppBtn");
    const nextBtn = document.getElementById("nextBtn");
    const autoBtn = document.getElementById("autoBtn");
    const seek    = document.getElementById("seek");
    const tCur    = document.getElementById("tCur");
    const tDur    = document.getElementById("tDur");

    let currentIndex = -1;
    let autoNext = false;
    let seeking = false;

    function fmtTime(sec){
      if(!isFinite(sec) || sec < 0) return "0:00";
      const m = Math.floor(sec/60);
      const s = Math.floor(sec%60);
      return m + ":" + String(s).padStart(2,"0");
    }

    function setPlayingIndex(i){
      currentIndex = i;
      tracks.forEach(t=> t.classList.remove("playing"));
      if(i >= 0 && tracks[i]) tracks[i].classList.add("playing");
    }

    function setSongPlaying(on){
      isSongPlaying = on;

      // si empieza canci√≥n: apagar idle visual y audios idle
      if(on){
        setIdle(false);
        stopIdleAudio();
        document.body.classList.remove("idle");
      }else{
        // si se detiene canci√≥n: reiniciar conteo idle
        resetIdle();
      }
    }

    function loadTrack(i){
      if(i < 0 || i >= tracks.length) return;
      const el = tracks[i];
      const src = (el.dataset.src || "").trim();

      setPlayingIndex(i);

      // si no hay src, no podemos reproducir, pero igual ‚Äúmarca‚Äù la selecci√≥n
      if(!src){
        showWhisper("Good. You chose music.");
        setSongPlaying(false);
        return;
      }

      player.src = src;
      player.currentTime = 0;
    }

    function playCurrent(){
      if(currentIndex < 0) return;
      const el = tracks[currentIndex];
      const src = (el.dataset.src || "").trim();
      if(!src){
        showWhisper("Good. You chose music.");
        return;
      }

      showWhisper("Good. You chose music.");
      player.volume = 0.55;

      player.play().then(()=>{
        setSongPlaying(true);
      }).catch(()=>{});
    }

    function pauseCurrent(){
      try{ player.pause(); }catch(e){}
      setSongPlaying(false);
    }

    function playTrackAt(i){
      if(!audioUnlocked) unlockAudioNow();
      loadTrack(i);
      playCurrent();
    }

    function playTrack(el){
      if(!audioUnlocked) unlockAudioNow();
      const i = Number(el.dataset.index);
      playTrackAt(i);
    }

    tracks.forEach(el=> el.addEventListener("click", ()=> playTrack(el)));

    panicBtn.addEventListener("click", ()=>{
      if(!audioUnlocked) unlockAudioNow();
      const i = Math.floor(Math.random()*tracks.length);
      playTrackAt(i);
    });

    prevBtn.addEventListener("click", ()=>{
      if(tracks.length === 0) return;
      const i = (currentIndex <= 0) ? tracks.length - 1 : currentIndex - 1;
      playTrackAt(i);
    });

    nextBtn.addEventListener("click", ()=>{
      if(tracks.length === 0) return;
      const i = (currentIndex >= tracks.length - 1) ? 0 : currentIndex + 1;
      playTrackAt(i);
    });

    ppBtn.addEventListener("click", ()=>{
      if(currentIndex < 0){
        // si no hay track seleccionado, inicia random
        const i = Math.floor(Math.random()*tracks.length);
        playTrackAt(i);
        return;
      }

      if(!player.src){
        // no hay audio, solo toggle visual
        showWhisper("Pick a cassette.");
        return;
      }

      if(player.paused) playCurrent();
      else pauseCurrent();
    });

    autoBtn.addEventListener("click", ()=>{
      autoNext = !autoNext;
      autoBtn.classList.toggle("on", autoNext);
      autoBtn.textContent = autoNext ? "AUTO: ON" : "AUTO: OFF";
    });

    // progreso
    player.addEventListener("loadedmetadata", ()=>{
      tDur.textContent = fmtTime(player.duration);
    });

    player.addEventListener("timeupdate", ()=>{
      if(seeking) return;
      tCur.textContent = fmtTime(player.currentTime);
      if(isFinite(player.duration) && player.duration > 0){
        seek.value = Math.floor((player.currentTime / player.duration) * 1000);
      }else{
        seek.value = 0;
      }
    });

    seek.addEventListener("pointerdown", ()=>{ seeking = true; });
    seek.addEventListener("pointerup", ()=>{
      seeking = false;
      if(isFinite(player.duration) && player.duration > 0){
        const p = Number(seek.value) / 1000;
        player.currentTime = p * player.duration;
      }
    });
    seek.addEventListener("input", ()=>{
      if(isFinite(player.duration) && player.duration > 0){
        const p = Number(seek.value) / 1000;
        const preview = p * player.duration;
        tCur.textContent = fmtTime(preview);
      }
    });

    // al terminar:
    player.addEventListener("ended", ()=>{
      setSongPlaying(false);
      if(autoNext){
        const i = (currentIndex >= tracks.length - 1) ? 0 : currentIndex + 1;
        playTrackAt(i);
      }else{
        // queda resaltado, pero no suena nada
        showWhisper("Paused. Choose next.");
      }
    });

    // si pausas manual
    player.addEventListener("pause", ()=>{
      if(player.currentTime > 0 && player.currentTime < (player.duration || Infinity)){
        setSongPlaying(false);
      }
    });

    // init: dejar AUTO en OFF visible
    autoBtn.textContent = "AUTO: OFF";

    // =========================
    // EASTER: 7 taps en logo
    // =========================
    let logoTaps = 0;
    const logo = document.getElementById("logo");
    logo.addEventListener("click", ()=>{
      if(!audioUnlocked) unlockAudioNow();
      resetIdle();
      logoTaps++;
      if(logoTaps >= 7){
        logoTaps = 0;
        openModal("SE√ëAL ENCONTRADA", "Hawkins responde. El ruido baja‚Ä¶ por ahora.");
      }
    });
  </script>
</body>
</html>
